# candle_batch_aggregator: задачи и reasoning

## Цель
Реализовать CLI-инструмент для пакетной агрегации свечей из трейдов с поддержкой CSV, Parquet, DuckDB, QuestDB, ClickHouse и других форматов. Гибкая архитектура, расширяемость через адаптеры, интеграция с ядром candle_generator.

---

## Прогресс
- [x] CSV: чтение трейдов, агрегация, экспорт свечей, поддержка кастомных метрик через ядро candle_generator
- [x] Parquet: чтение трейдов через polars, запись свечей через polars DataFrame, подключено в main.rs
- [x] README обновлён, добавлен пример запуска для Parquet и требования к структуре входных файлов
- [x] Happy-path пример для Parquet (examples/parquet_batch.rs): генерация трейдов, сохранение в Parquet, batch-агрегация, вывод результата
- [x] DuckDB: чтение трейдов, запись свечей, интеграция в main.rs
- [x] Пример использования DuckDB (examples/duckdb_batch.rs): генерация трейдов, сохранение в DuckDB, batch-агрегация, вывод результата
- [x] QuestDB: чтение трейдов через HTTP API, запись свечей, интеграция в main.rs
- [x] Пример использования QuestDB (examples/questdb_batch.rs): читает URL из questdb_url.txt, получает трейды через HTTP, batch-агрегация, вывод результата
- [x] ClickHouse: чтение трейдов через HTTP API, запись свечей, интеграция в main.rs
- [x] Пример использования ClickHouse (examples/clickhouse_batch.rs): читает URL из clickhouse_url.txt, получает трейды через HTTP, batch-агрегация, вывод результата
- [x] Покрыть happy-path тестами и примерами

---

## Reasoning
- Каждый формат реализуется как отдельный модуль-адаптер, который конвертирует трейды в универсальную структуру Trade из candle_generator.
- После чтения трейдов из любого формата, агрегация и экспорт свечей происходят через уже реализованный пайплайн (aggregation.rs).
- Сначала реализуем Parquet (как наиболее востребованный формат для хранения исторических данных), затем аналогично — DuckDB, QuestDB, ClickHouse.
- Примеры для чтения Parquet уже есть в examples/from_parquet.rs (можно использовать как шаблон).

---

## Финальные рекомендации и развитие
- Добавлять новые edge-cases и сценарии через PR/issues и фиксировать их в examples/ и тестах
- Для новых источников и форматов — реализовывать адаптеры и примеры
- Для новых метрик — реализовывать CandleMetric и покрывать тестами
- Регулярно обновлять README.md и tasks/candle_batch_aggregator.md при изменениях
- Настроить CI для автоматической проверки тестов и сборки примеров
- Следить за производительностью: периодически запускать бенчмарки и фиксировать результаты
- Принимать обратную связь от пользователей и инвесторов, интегрировать новые сценарии

---

## Следующие шаги
1. Реализовать ClickHouse по аналогии (чтение трейдов, запись свечей, интеграция в main.rs, пример).

---

## Пути, которые уже проверены и не требуют повторной проверки
- Механика агрегации и экспорта для CSV и Parquet полностью рабочая.
- candle_generator::Trade и Candle универсальны для всех форматов.
- Примеры для чтения Parquet уже есть в examples/from_parquet.rs (можно использовать как шаблон). 